name: Monthly Build and Release

on:
  schedule:
    - cron: '0 0 */30 * *' # Runs every 30 days

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch Highest Tag
        id: highest-tag
        run: |
          git fetch --tags
          echo "::set-output name=tag::$(git describe --tags $(git rev-list --tags --max-count=1))"

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.highest-tag.outputs.tag }}

      - name: Install Go
        uses: actions/setup-go@v4
        with:
          go-version: ">=1.22"
    
      - name: Print Go version
        run: go version

      - name: Build for Linux
        run: CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o go-proxy ./main.go

      - name: Package Binary
        run: tar -czvf go-proxy-${{ steps.highest-tag.outputs.tag }}.tar.gz go-proxy

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: ./go-proxy-${{ steps.highest-tag.outputs.tag }}.tar.gz
          name: Release ${{ steps.highest-tag.outputs.tag }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Print Release URL
        run: echo ${{ steps.create_release.outputs.url }}
